<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ã‹ã‚“ãŸã‚“å®¶è¨ˆç°¿</title>

<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family:sans-serif; background:#f5f5f5; margin:0; padding:10px; }
h2 { margin:10px 0; }
.card { background:white; padding:10px; border-radius:12px; margin-bottom:10px; }
button { padding:8px 12px; margin:4px; border:none; border-radius:10px; }
input, select { padding:6px; margin:4px 0; }

.tab { background:#ddd; }
.tab.active { background:#4caf50; color:white; }

.cat { font-size:12px; }
.cat.active { outline:2px solid black; }

.row { border-bottom:1px solid #eee; padding:6px 0; font-size:14px; }
.small { color:#666; font-size:12px; }

.flex { display:flex; flex-wrap:wrap; }
</style>
</head>

<body>

<h2>ğŸ’¸ å®¶è¨ˆç°¿</h2>

<div class="card">
é‡‘é¡ï¼š<input type="number" id="amount" style="width:100px;">
ãƒ¡ãƒ¢ï¼š<input type="text" id="note" placeholder="ä¾‹ï¼šã‚¹ãƒ¼ãƒ‘ãƒ¼" style="width:60%;">
<br>
<div class="flex" id="catButtons"></div>
<button onclick="saveEntry()">ä¿å­˜</button>
</div>

<div class="card">
<button class="tab active" onclick="showTab('history')">å±¥æ­´</button>
<button class="tab" onclick="showTab('graph')">ã‚°ãƒ©ãƒ•</button>
</div>

<!-- å±¥æ­´ -->
<div id="historyTab" class="card"></div>

<!-- ã‚°ãƒ©ãƒ• -->
<div id="graphTab" style="display:none;">
  <div class="card">
    å¹´ï¼š
    <select id="yearSelect" onchange="draw()"></select>
  </div>

  <div class="card">
    <button onclick="setGraph('bar')">æ£’ã‚°ãƒ©ãƒ•</button>
    <button onclick="setGraph('pie')">å††ã‚°ãƒ©ãƒ•</button>
  </div>

  <div class="card" id="barOptions">
    è¡¨ç¤ºï¼š
    <select id="barMode" onchange="draw()">
      <option value="all">å…¨æ”¯å‡º</option>
    </select>
  </div>

  <div class="card">
    <canvas id="chart"></canvas>
  </div>
</div>

<script>
const categories = [
 {name:"é£Ÿäº‹",color:"#ff7043"},
 {name:"æ—¥ç”¨å“",color:"#8d6e63"},
 {name:"è¶£å‘³å¨¯æ¥½",color:"#42a5f5"},
 {name:"äº¤éš›è²»",color:"#ec407a"},
 {name:"äº¤é€šè²»",color:"#26a69a"},
 {name:"è¡£æœç¾å®¹",color:"#ab47bc"},
 {name:"å¥åº·åŒ»ç™‚",color:"#66bb6a"},
 {name:"è‡ªå‹•è»Š",color:"#78909c"},
 {name:"æ•™è‚²",color:"#5c6bc0"},
 {name:"ç‰¹åˆ¥ãªæ”¯å‡º",color:"#ffa726"},
 {name:"ç¾é‡‘ã‚«ãƒ¼ãƒ‰",color:"#d4e157"},
 {name:"é€šä¿¡è²»",color:"#29b6f6"},
 {name:"ä½å®…",color:"#8d6e63"},
 {name:"ä¿é™º",color:"#26c6da"},
 {name:"ãã®ä»–",color:"#bdbdbd"}
];

let selectedCat = categories[0].name;
let editIndex = null;
let currentGraph = "bar";
let chartObj = null;

const catButtons = document.getElementById("catButtons");
categories.forEach(c=>{
 const b=document.createElement("button");
 b.textContent=c.name;
 b.className="cat";
 b.style.background=c.color;
 b.onclick=()=>selectCat(c.name,b);
 catButtons.appendChild(b);
});
catButtons.firstChild.classList.add("active");

function selectCat(name,btn){
 selectedCat=name;
 document.querySelectorAll(".cat").forEach(b=>b.classList.remove("active"));
 btn.classList.add("active");
}

function load(){
 return JSON.parse(localStorage.getItem("kakeibo")||"[]");
}
function save(d){
 localStorage.setItem("kakeibo",JSON.stringify(d));
}

function saveEntry(){
 const amt=Number(amount.value);
 if(!amt) return;
 const d=load();
 const entry={
   date:new Date().toISOString().slice(0,10),
   amount:amt, cat:selectedCat, note:note.value||""
 };
 if(editIndex!==null){
   d[editIndex]=entry;
   editIndex=null;
 }else{
   d.push(entry);
 }
 save(d);
 amount.value=""; note.value="";
 drawHistory(); draw();
}

function drawHistory(){
 const d=load().sort((a,b)=>b.date.localeCompare(a.date));
 const div=document.getElementById("historyTab");
 div.innerHTML="<h3>ğŸ“… å±¥æ­´</h3>"+d.map((r,i)=>`
 <div class="row">
 ${r.date} ${r.cat} Â¥${r.amount.toLocaleString()}<br>
 <span class="small">${r.note}</span><br>
 <button onclick="edit(${i})">ç·¨é›†</button>
 <button onclick="del(${i})">å‰Šé™¤</button>
 </div>`).join("");
}

function edit(i){
 const d=load();
 const r=d[i];
 amount.value=r.amount;
 note.value=r.note;
 selectedCat=r.cat;
 editIndex=i;
}

function del(i){
 if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
 const d=load(); d.splice(i,1); save(d);
 drawHistory(); draw();
}

function showTab(t){
 historyTab.style.display = t==="history"?"block":"none";
 graphTab.style.display = t==="graph"?"block":"none";
 document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
 event.target.classList.add("active");

 if(t==="graph"){
   setTimeout(()=>draw(),50); // è¡¨ç¤ºå¾Œã«æç”»ã—ç›´ã™
 }
}


function setGraph(t){
 currentGraph=t;
 barOptions.style.display = t==="bar"?"block":"none";
 draw();
}

function draw(){
 const data=load();
 const y=yearSelect.value;
 const monthly={};
 categories.forEach(c=>monthly[c.name]=Array(12).fill(0));
 data.forEach(r=>{
   if(r.date.startsWith(y)){
     const m=Number(r.date.slice(5,7))-1;
     monthly[r.cat][m]+=r.amount;
   }
 });

 chartObj?.destroy();

 if(currentGraph==="pie"){
   const totals={};
   categories.forEach(c=>totals[c.name]=monthly[c.name].reduce((a,b)=>a+b,0));
   chartObj=new Chart(chart,{
     type:"pie",
     data:{
       labels:Object.keys(totals),
       datasets:[{data:Object.values(totals),
         backgroundColor:categories.map(c=>c.color)}]
     }
   });
 }else{
   const mode=barMode.value;
   let datasets=[];
   if(mode==="all"){
     const all=Array(12).fill(0);
     categories.forEach(c=>monthly[c.name].forEach((v,i)=>all[i]+=v));
     datasets=[{label:"å…¨æ”¯å‡º",data:all}];
   }else{
     datasets=[{label:mode,data:monthly[mode]}];
   }
   chartObj=new Chart(chart,{
     type:"bar",
     data:{labels:[...Array(12)].map((_,i)=>i+1+"æœˆ"),datasets}
   });
 }
}

function init(){
 const data=load();
 const years=[...new Set(data.map(r=>r.date.slice(0,4)))];
 const y=new Date().getFullYear().toString();
 if(!years.includes(y)) years.push(y);
 yearSelect.innerHTML=years.map(v=>`<option>${v}</option>`).join("");
 yearSelect.value=y;

 barMode.innerHTML='<option value="all">å…¨æ”¯å‡º</option>'+
   categories.map(c=>`<option>${c.name}</option>`).join("");

 drawHistory(); draw();
}

init();
</script>

</body>
</html>
