<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ã‹ã‚“ãŸã‚“å®¶è¨ˆç°¿</title>

<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: sans-serif; background:#f5f5f5; margin:0; padding:10px; }
h2 { margin-top:20px; }
.card { background:white; padding:10px; border-radius:10px; margin-bottom:10px; }
button { padding:8px 12px; margin:4px; border:none; border-radius:8px; }
.cat { background:#ddd; }
.cat.active { background:#4caf50; color:white; }
input, select { padding:6px; margin:4px 0; }
.list { font-size:14px; line-height:1.6; }
.row { border-bottom:1px solid #eee; padding:4px 0; }
.small { color:#666; font-size:12px; }
</style>
</head>

<body>

<h2>ğŸ’¸ ã‹ã‚“ãŸã‚“å®¶è¨ˆç°¿</h2>

<div class="card">
  é‡‘é¡ï¼š<input type="number" id="amount" style="width:100px;"><br>
  ãƒ¡ãƒ¢ï¼š<input type="text" id="note" placeholder="ä¾‹ï¼šã‚¹ãƒ¼ãƒ‘ãƒ¼ã€æ˜¼ã”ã¯ã‚“" style="width:90%;"><br>

  <div>
    <button class="cat active" onclick="setCat('é£Ÿè²»')">ğŸšé£Ÿè²»</button>
    <button class="cat" onclick="setCat('äº¤é€š')">ğŸšƒäº¤é€š</button>
    <button class="cat" onclick="setCat('ç”Ÿæ´»')">ğŸ ç”Ÿæ´»</button>
    <button class="cat" onclick="setCat('å¨¯æ¥½')">ğŸ®å¨¯æ¥½</button>
    <button class="cat" onclick="setCat('åŒ»ç™‚')">ğŸ’ŠåŒ»ç™‚</button>
    <button class="cat" onclick="setCat('ãã®ä»–')">ğŸ“¦ãã®ä»–</button>
  </div>

  <button onclick="add()">è¿½åŠ </button>
</div>

<div class="card">
  å¹´ï¼š
  <select id="yearSelect" onchange="draw()"></select>
</div>

<div class="card">
  <canvas id="bar"></canvas>
</div>

<div class="card">
  <canvas id="pie"></canvas>
</div>

<div class="card">
  <h3>ğŸ“Š ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥ åˆè¨ˆï¼ˆé«˜ã„é †ï¼‰</h3>
  <div id="catList" class="list"></div>
</div>

<div class="card">
  <h3>ğŸ“… å±¥æ­´</h3>
  <div id="history" class="list"></div>
</div>

<script>
let selectedCat = "é£Ÿè²»";
let barChart, pieChart;

function setCat(c){
  selectedCat = c;
  document.querySelectorAll(".cat").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
}

function load(){
  return JSON.parse(localStorage.getItem("kakeibo")||"[]");
}

function save(d){
  localStorage.setItem("kakeibo",JSON.stringify(d));
}

function add(){
  const amt = Number(amount.value);
  if(!amt) return;

  const d = load();
  d.push({
    date:new Date().toISOString().slice(0,10),
    amount:amt,
    cat:selectedCat,
    note: note.value || ""
  });

  save(d);
  amount.value="";
  note.value="";
  draw();
}

function draw(){
  const data = load();
  const y = yearSelect.value;

  const monthly = Array(12).fill(0);
  const cats = {};
  const history = [];

  data.forEach(r=>{
    const [yy,mm] = r.date.split("-");
    if(yy===y){
      monthly[Number(mm)-1]+=r.amount;
      cats[r.cat]=(cats[r.cat]||0)+r.amount;
      history.push(r);
    }
  });

  // ã‚°ãƒ©ãƒ•
  barChart?.destroy();
  pieChart?.destroy();

  barChart = new Chart(bar,{
    type:"bar",
    data:{labels:[...Array(12)].map((_,i)=>i+1+"æœˆ"),datasets:[{data:monthly}]}
  });

  pieChart = new Chart(pie,{
    type:"pie",
    data:{labels:Object.keys(cats),datasets:[{data:Object.values(cats)}]}
  });

  // ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥ãƒªã‚¹ãƒˆï¼ˆé«˜ã„é †ï¼‰
  const catSorted = Object.entries(cats).sort((a,b)=>b[1]-a[1]);
  catList.innerHTML = catSorted.map(
    ([k,v])=>`<div class="row">${k}ï¼šÂ¥${v.toLocaleString()}</div>`
  ).join("");

  // å±¥æ­´ï¼ˆæ—¥ä»˜æ–°ã—ã„é †ï¼‰
  history.sort((a,b)=>b.date.localeCompare(a.date));
  historyDiv.innerHTML = history.map(r=>
    `<div class="row">
      ${r.date}ã€€${r.cat}ã€€Â¥${r.amount.toLocaleString()}<br>
      <span class="small">${r.note}</span>
    </div>`
  ).join("");
}

function init(){
  const data = load();
  const years=[...new Set(data.map(r=>r.date.slice(0,4)))];
  const y = new Date().getFullYear().toString();
  if(!years.includes(y)) years.push(y);
  yearSelect.innerHTML = years.map(v=>`<option>${v}</option>`).join("");
  yearSelect.value=y;
  draw();
}

const historyDiv = document.getElementById("history");
init();
</script>

</body>
</html>
